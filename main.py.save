from fastapi import FastAPI
from pydantic import BaseModel
import logging
import os

from agent.decision import decide_action
from agent.responder import generate_response

app = FastAPI(title="Healthcare Information Navigator")
logging.basicConfig(level=logging.INFO)

class ChatRequest(BaseModel):
    message: str

# ---- Load knowledge base ----
def load_knowledge():
    knowledge = {}
    folder = "knowledge_base"

    for filename in os.listdir(folder):
        if filename.endswith(".txt"):
            with open(os.path.join(folder, filename), "r") as file:
                blocks = file.read().split("\n\n")
                for block in blocks:
                    question = block.split("\n")[0].lower()
                    knowledge[question] = block

    return knowledge

knowledge_db = load_knowledge()

@app.get("/")
def home():
    return {"status": "Backend is running"}

@app.post("/agent")
def agent_chat(request: ChatRequest):
    user_message = request.message

    decision = decide_action(user_message)
    logging.info(f"Agent decision: {decision}")

    if decision == "search_knowledge":
        for question, answer in knowledge_db.items():
            if user_message.lower() in question:
                return {"reply": answer}

        return {"reply": "I couldn't find exact information. Please rephrase your question."}

    return {"reply": generate_response(user_message)}
from fastapi import FastAPI
from pydantic import BaseModel
import logging
import os

# ---- Create the app ----
app = FastAPI(title="Healthcare Information Navigator")
logging.basicConfig(level=logging.INFO)

# ---- Pydantic model for requests ----
class ChatRequest(BaseModel):
    message: str

# ---- Load all knowledge files from the folder as Q&A pairs ----
def load_knowledge():
    knowledge = {}
    folder = "knowledge_base"
    if not os.path.exists(folder):
        logging.warning(f"Knowledge folder '{folder}' does not exist.")
        return knowledge
    
    for filename in os.listdir(folder):
        if filename.endswith(".txt"):
            filepath = os.path.join(folder, filename)
            with open(filepath, "r") as file:
                # Split into paragraphs
                chunks = file.read().split("\n\n")
                for chunk in chunks:
                    lines = chunk.strip().split("\n", 1)
                    if len(lines) == 2:
                        question = lines[0].strip().lower()
                        answer = lines[1].strip()
                        knowledge[question] = answer
    return knowledge

# ---- Load knowledge at startup ----
knowledge_dict = load_knowledge()
print("Knowledge loaded:", knowledge_dict)

# ---- Endpoints ----
@app.get("/")
def home():
    return {"status": "Backend is running"}

@app.post("/chat")
def chat(request: ChatRequest):
    logging.info(f"User said: {request.message}")
    return {"reply": "This is a dummy agent response"}

@app.post("/agent-decision")
def agent_decision(request: ChatRequest):
    return {
        "decision": "select_best_page",
        "reason": "Demo decision logic"
    }

@app.post("/knowledge-search")
def knowledge_search(request: ChatRequest):
    query = request.message.lower().strip()

    # Return exact match if found
    answer = knowledge_dict.get(query)
    if answer:
        return {"reply": answer}

    # If no exact match, fallback to keyword search
    results = []
    for question, response in knowledge_dict.items():
        if any(word in question for word in query.split()):
            results.append(response)
    
    if results:
        return {"reply": results[0]}  # Return first relevant match
    
    # Final fallback
    return {"reply": "Sorry, I don't have information on that. Can you clarify?"}

